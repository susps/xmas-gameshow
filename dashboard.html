<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lobby Hub</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <style>
        /* General Layout */
        body {
            height: 100vh;
            background: #161616;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }

        .lobby-container {
            background: #1e1e1e;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            width: 90%;
            max-width: 450px;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            z-index: 10;
        }

        /* User Section */
        .user-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 1rem;
        }

        .avatar-image {
            width: 5rem;
            height: 5rem;
            border-radius: 50%;
            margin-bottom: 0.5rem;
            border: 3px solid #e63946;
        }

        .username {
            font-size: 1.5rem;
            font-weight: 700;
            color: #4ade80; /* Light green for username */
        }

        /* Error Banner */
        .error-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: #f87171;
            color: white;
            text-align: center;
            padding: 0.75rem;
            font-weight: 600;
            z-index: 100;
        }

        /* Buttons and Inputs */
        .enter-button {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            border-radius: 8px;
            font-weight: 700;
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            text-decoration: none; /* For host link */
        }

        .host-button {
            background-color: #e63946; /* Christmas Red */
            color: white;
        }

        .host-button:hover {
            background-color: #d12e3b;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
        }

        .join-button {
            background-color: #4ade80; /* Christmas Green */
            color: #1e1e1e;
        }

        .join-button:hover {
            background-color: #22c55e;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
        }

        .ready-button {
            background-color: #3b82f6; /* Blue for Ready */
            color: white;
        }

        .ready-button.unready {
            background-color: #f97316; /* Orange for Unready */
        }

        .ready-button:hover:not(:disabled) {
            transform: scale(1.02);
            opacity: 0.9;
        }
        
        .ready-button:disabled {
            background-color: #6b7280;
            cursor: not-allowed;
            opacity: 0.6;
        }

        #lobby-code-input {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border-radius: 8px;
            border: 2px solid #6b7280;
            background-color: #2d2d2d;
            color: white;
            text-align: center;
            font-size: 1.25rem;
            text-transform: uppercase;
            letter-spacing: 0.2em;
        }

        /* Lobby Section */
        .separator {
            border: 0;
            height: 1px;
            background-image: linear-gradient(to right, rgba(230, 57, 70, 0), rgba(230, 57, 70, 0.75), rgba(230, 57, 70, 0));
        }

        .action-header, .lobby-header {
            font-size: 1.25rem;
            font-weight: 600;
            color: #d1d5db;
            text-align: center;
            margin-bottom: 1rem;
        }
        
        .code-display {
            font-size: 1.5rem;
            font-weight: 800;
            color: #4ade80;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        .player-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 250px;
            overflow-y: auto;
            padding: 0.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid #374151;
            border-radius: 8px;
        }

        .player-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #2d2d2d;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            border-left: 5px solid transparent;
        }
        
        .player-me {
            border-left-color: #3b82f6;
            background-color: #374151;
        }

        .player-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .player-info {
            flex-grow: 1;
            text-align: left;
        }

        .player-name {
            font-weight: 600;
        }
        
        .player-score {
            font-size: 0.8rem;
            color: #9ca3af;
        }

        .player-status-container {
            min-width: 90px;
            text-align: right;
        }

        .player-status {
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .player-status.ready {
            background-color: #4ade80;
            color: #1e1e1e;
        }

        .player-status.waiting {
            background-color: #facc15;
            color: #1e1e1e;
        }

        .player-disconnected {
            opacity: 0.5;
            filter: grayscale(100%);
        }
        
        .player-disconnected .player-status {
            background-color: #9ca3af;
        }
        
        .disconnect-info {
            font-size: 0.8rem;
            color: #9ca3af;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
            padding: 0 0.5rem;
        }
    </style>
</head>

<body>
    <div id="error-banner" class="error-banner" style="display: none;"></div>

    <div class="lobby-container">
        
        <div class="user-section">
            <img src="https://placehold.co/128x128/FF0000/FFFFFF?text=P" id="avatar" class="avatar-image"/>
            <div id="name" class="username">Loading...</div>
        </div>

        <!-- Section 1: Create Game Button (HOST Option) -->
        <!-- Changed to a button to handle logic via JS instead of a direct link -->
        <div id="create-section" class="lobby-action-section mb-8">
            <button id="create-lobby-button" class="host-button enter-button">
                <i class="fa-solid fa-crown"></i>
                <span>Create New Game (Host)</span>
            </button>
        </div>

        <hr class="separator"/>

        <!-- Section 2: Join Game (PLAYER Option) -->
        <div id="join-section" class="lobby-action-section">
            <h3 class="action-header">Or Join an Existing Game</h3>
            <input 
                type="text" 
                id="lobby-code-input" 
                placeholder="Enter Lobby Code (e.g., ABCD)"
                maxlength="4"
                autocomplete="off"
            />
            <button id="enter-lobby-button" class="join-button enter-button">
                <i class="fa-solid fa-right-to-bracket"></i>
                <span>Join Lobby</span>
            </button>
        </div>

        <!-- Section 3: Lobby Waiting Area (Hidden until joined) -->
        <div id="lobby-section" style="display: none;" class="lobby-action-section">
            <h2 class="lobby-header">Lobby Code: <span id="display-lobby-code" class="code-display"></span></h2>
            
            <div id="player-list" class="player-list">
                <!-- Player cards will be inserted here -->
            </div>

            <button id="ready-button" class="ready-button enter-button" disabled>
                <i class="fa-solid fa-person-running"></i>
                <span>READY</span>
            </button>
            
            <p class="disconnect-info">
                <i class="fa-solid fa-circle-exclamation"></i>
                Wait here until the host starts the game. Do not refresh!
            </p>
        </div>
    </div>

    <!-- The Socket.IO script will be loaded dynamically in JS -->
    <script>
        // Use the current host/port for the server URL
        const SERVER_URL = `${window.location.protocol}//${window.location.host.split(':')[0]}:53134`;

        // DOM Elements
        const createLobbyButton = document.getElementById('create-lobby-button');
        const joinSection = document.getElementById('join-section');
        const lobbySection = document.getElementById('lobby-section');
        const lobbyCodeInput = document.getElementById('lobby-code-input');
        const enterLobbyButton = document.getElementById('enter-lobby-button');
        const readyButton = document.getElementById('ready-button');
        const displayLobbyCode = document.getElementById('display-lobby-code');
        const playerList = document.getElementById('player-list');
        const errorBanner = document.getElementById('error-banner');

        let discordUser = null;
        let socket = null;

        // --- Utility Functions ---

        /**
         * Shows a temporary error message in the UI.
         */
        function displayError(message) {
            errorBanner.textContent = message;
            errorBanner.style.display = 'block';
            setTimeout(() => {
                errorBanner.style.display = 'none';
                errorBanner.textContent = '';
            }, 5000);
        }

        /**
         * Renders the list of players in the lobby.
         */
        function renderPlayerList(players, myId) {
            playerList.innerHTML = ''; // Clear existing players

            players.sort((a, b) => b.score - a.score).forEach(player => {
                const isMe = player.discordId === myId;
                const playerCard = document.createElement('div');
                playerCard.className = `player-card ${isMe ? 'player-me' : ''} ${!player.isConnected ? 'player-disconnected' : ''}`;
                
                // Construct Discord avatar URL
                const avatarUrl = player.avatar ? 
                    `https://cdn.discordapp.com/avatars/${player.discordId}/${player.avatar}.jpg` : 
                    `https://placehold.co/128x128/FF0000/FFFFFF?text=${player.name ? player.name.charAt(0) : 'P'}`; // Fallback placeholder

                playerCard.innerHTML = `
                    <img src="${avatarUrl}" alt="${player.name}'s avatar" class="player-avatar" onerror="this.onerror=null;this.src='https://placehold.co/128x128/FF0000/FFFFFF?text=${player.name ? player.name.charAt(0) : 'P'}';" />
                    <div class="player-info">
                        <div class="player-name">${player.name}${isMe ? ' (You)' : ''}</div>
                        <div class="player-score">Score: ${player.score || 0}</div>
                    </div>
                    <div class="player-status-container">
                        <div class="player-status ${player.isReady ? 'ready' : 'waiting'}">
                            ${!player.isConnected ? 'DISCONNECTED' : (player.isReady ? 'READY' : 'WAITING')}
                        </div>
                    </div>
                `;
                playerList.appendChild(playerCard);
            });
        }

        /**
         * Handles all Socket.IO events for the lobby and game flow.
         */
        function setupLobbyListeners() {
            // Note: io() is available because the script is loaded dynamically in the window.load handler
            socket = io(SERVER_URL);

            socket.on('connect', () => {
                console.log("Connected to server via Socket.IO");
                // Re-emit join_game if user was already in a lobby (e.g., after a disconnect or refresh)
                const lobbyCode = localStorage.getItem('lobbyCode');
                if (lobbyCode) {
                    // Re-join lobby automatically
                    joinLobby(lobbyCode);
                }
            });

            socket.on('connect_error', (err) => {
                console.error("Socket.IO connection error:", err);
                displayError("Could not connect to the game server. Please try refreshing.");
                enterLobbyButton.disabled = false;
                createLobbyButton.disabled = false;
                readyButton.disabled = true;
            });

            // Event received when a new lobby is created (only for the creator)
            socket.on('lobby_created', (data) => {
                console.log(`Lobby created: ${data.lobbyCode}`);
                // Since lobby_update will follow immediately, we primarily rely on that.
            });

            // Event received when the lobby state or player list changes
            socket.on('lobby_update', (data) => {
                const { lobbyCode, players, currentStage, isHost } = data;
                console.log('Lobby Update:', data);
                
                localStorage.setItem('lobbyCode', lobbyCode);
                displayLobbyCode.innerText = lobbyCode;
                renderPlayerList(players, discordUser.id);

                if (currentStage === 'LOBBY') {
                    // Show lobby waiting area
                    joinSection.style.display = 'none';
                    createLobbyButton.parentNode.style.display = 'none'; // Hide create section
                    lobbySection.style.display = 'flex';
                    
                    // Enable ready button once in a lobby
                    readyButton.disabled = false;
                    
                    // Update ready button text based on current player's state
                    const currentPlayer = players.find(p => p.discordId === discordUser.id);
                    if (currentPlayer) {
                        readyButton.innerHTML = currentPlayer.isReady ? 
                            '<i class="fa-solid fa-hourglass-half"></i><span>UNREADY</span>' : 
                            '<i class="fa-solid fa-person-running"></i><span>READY</span>';
                        readyButton.classList.toggle('unready', currentPlayer.isReady);
                    }
                } else if (currentStage !== 'LOBBY') {
                    // Game is starting or in progress
                    console.log("Game started! Redirecting to game board...");
                    // Use session storage to pass necessary info (Discord user + lobby code)
                    sessionStorage.setItem('game_start_data', JSON.stringify({ 
                        discordUser, 
                        lobbyCode,
                        players: players 
                    })); 
                    window.location.href = `/game.html?code=${lobbyCode}`;
                }
            });
            
            // Event received on specific errors (e.g., lobby not found)
            socket.on('lobby_error', (message) => {
                console.error('Lobby Error:', message);
                displayError(message);
                // Re-enable buttons
                enterLobbyButton.disabled = false;
                createLobbyButton.disabled = false;
            });
            
            // --- Game Flow Events (For Rejoin) ---
            
            // If a player joins a game already in progress
            socket.on('rejoin_game_state', (data) => {
                console.log("Rejoining active game. Redirecting to game board...");
                sessionStorage.setItem('game_start_data', JSON.stringify({ 
                    discordUser, 
                    lobbyCode: data.lobbyCode,
                    rejoinState: data // Pass full game state for re-sync
                })); 
                window.location.href = `/game.html?code=${data.lobbyCode}`;
            });

            // --- Lobby UI Interaction Handlers ---

            // Handler for "Create New Game (Host)" button
            createLobbyButton.addEventListener('click', () => {
                createLobbyButton.disabled = true; // Prevent spamming
                joinLobby(''); // Pass empty code to signal new lobby creation
            });
            
            // Handler for "Join Lobby" button
            enterLobbyButton.addEventListener('click', () => {
                const lobbyCode = lobbyCodeInput.value.toUpperCase().trim();
                if (lobbyCode.length !== 4) {
                    displayError("Lobby code must be 4 characters.");
                    return;
                }
                enterLobbyButton.disabled = true; // Prevent spamming
                joinLobby(lobbyCode);
            });

            readyButton.addEventListener('click', () => {
                if (socket && discordUser) {
                    socket.emit('player_ready');
                }
            });
        }

        /**
         * Emits the join_game event to the server.
         * @param {string} code - The 4-character lobby code, or empty string for creating a new lobby.
         */
        function joinLobby(code) {
            if (socket && discordUser) {
                socket.emit('join_game', {
                    discordUser: {
                        id: discordUser.id,
                        name: discordUser.name,
                        avatar: discordUser.avatar
                    },
                    code: code 
                });
            } else {
                displayError("Authentication failed or socket not ready. Please refresh.");
                enterLobbyButton.disabled = false;
                createLobbyButton.disabled = false;
            }
        }


        // --- INITIAL AUTHENTICATION AND SETUP ---
        window.addEventListener('load', () => {
            // 1. Get Discord OAuth Token from hash fragment
            const fragment = new URLSearchParams(window.location.hash.slice(1));
            const accessToken = fragment.get("access_token");
            const tokenType = fragment.get("token_type");
            
            // Clear hash from URL to prevent token logging
            window.history.replaceState({}, document.title, window.location.pathname);

            if (!accessToken) {
                // If no token, redirect back to login page
                window.location.href = "/index.html";
                return;
            }
            
            // 2. Load Socket.IO client script dynamically
            // This is crucial for environments where the script path might be tricky.
            const socketIoScript = document.createElement('script');
            socketIoScript.src = `${SERVER_URL}/socket.io/socket.io.js`;
            
            socketIoScript.onerror = () => {
                console.error("Failed to load Socket.IO script.");
                displayError("Could not load networking libraries. Server may be down.");
            }

            socketIoScript.onload = () => {
                // 3. Fetch user data from Discord
                fetch("https://discord.com/api/users/@me", {
                    headers: { authorization: `${tokenType} ${accessToken}` },
                })
                .then(r => {
                    if (!r.ok) throw new Error("Discord API call failed");
                    return r.json();
                })
                .then(user => {
                    // Store user info
                    discordUser = {
                        id: user.id,
                        name: `${user.username}#${user.discriminator}`,
                        avatar: user.avatar
                    };

                    // Display user info
                    document.getElementById("name").innerText = discordUser.name;
                    document.getElementById("avatar").src =
                        `https://cdn.discordapp.com/avatars/${discordUser.id}/${discordUser.avatar}.jpg`;
                    
                    // Setup Socket.IO connection and lobby events
                    setupLobbyListeners();

                })
                .catch(error => {
                    console.error("Auth process error:", error);
                    displayError("Failed to fetch Discord user data. Please try logging in again.");
                    // Redirect after a delay
                    setTimeout(() => window.location.href = "/index.html", 3000); 
                });
            };
            document.head.appendChild(socketIoScript);
        });
    </script>
</body>
</html>